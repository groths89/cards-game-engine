name: "ðŸš€ Game Engine Pipeline: CI/CD"

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  release:
    types: [published]

jobs:
  set-env:
    name: "ðŸ” Determine Environment"
    runs-on: ubuntu-latest
    outputs:
      target_env: ${{ steps.check.outputs.env }}
    steps:
      - id: check
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "env=production" >> $GITHUB_OUTPUT
          else
            echo "env=development" >> $GITHUB_OUTPUT
          fi
  test:
    name: "ðŸ§ª Run Unit Tests"
    uses: ./.github/workflows/test.yml
    secrets: inherit
  build:
    name: "ðŸ”¨ Build & Push to ECR"
    needs: [test, set-env]
    uses: ./.github/workflows/build.yml
    with:
      environment: ${{ needs.set-env.outputs.target_env }}
    secrets: inherit
  deploy:
    name: "ðŸ“¦ Deploy to ECS"
    needs: [build, set-env]
    if: github.event_name == 'release'
    uses: ./.github/workflows/deploy.yml
    secrets: inherit
